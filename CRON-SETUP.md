# Настройка напоминания «за 10 мин» (при закрытом приложении)

Турнир в **понедельник в 5:31 (Бали, UTC+8)** → напоминание «за 10 мин» в **5:21 Бали**.

## Вариант 1: Vercel Cron (встроенный, работает автоматически)

В `vercel.json` уже настроен cron — каждый понедельник в 5:21 по Бали Vercel вызовет API.  
**Нужно:** в Vercel → Settings добавить секретный пароль для вызова. Vercel передаст его при вызове.

## Вариант 2: QStash (если Vercel Cron недоступен)

Используется Upstash QStash — тот же сервис, что и Redis. Расписание создаётся один раз.

### Шаг 1. Настройки в Vercel

В **Settings** добавьте:

- Секретный пароль для вызова (сгенерируйте на https://randomkeygen.com)
- Токен QStash — взять в [Upstash Console](https://console.upstash.com) → QStash (если ещё нет)
- URL и токен Redis, токен бота — если ещё не добавлены

### Шаг 2. Создать расписание

После деплоя откройте в браузере (подставьте свой секрет):

```
https://poker-app-ebon.vercel.app/api/setup-qstash-reminder?key=ВАШ_СЕКРЕТ
```

Должен вернуться `{"ok":true,"message":"QStash schedule created..."}`.

**Либо:** при первой подписке (кнопка «Напомнить за 10 минут») расписание создаётся автоматически.

### Итог

Расписание в QStash будет вызывать API каждый понедельник в 5:21 по Бали и отправлять сообщения всем подписчикам, даже если приложение закрыто.

---

## Вариант 3: cron-job.org (запасной)

Если QStash недоступен:

1. Зарегистрируйтесь на https://cron-job.org
2. **Create Cronjob:**
   - URL: `https://poker-app-ebon.vercel.app/api/freeroll-reminder-send?when=10min&secret=ВАШ_СЕКРЕТ`
   - Schedule: **Каждый понедельник, 05:21** (часовой пояс **Asia/Makassar**)

---

## Тест и проверка

- **Тест в приложении** — «Тест: отправить «за 10 мин» сейчас»
- **Проверка подписчиков** — `/api/debug-env?reminders=1` (если `subscribers10min` = 0 — нажмите «Напомнить за 10 минут»)

---

## Газета: пуши подписчикам и пост в чат

Оповещения о новых новостях приходят подписчикам **только после вызова** API (вручную, по крону или автоматически после пуша — см. ниже). Пользователи нажимают «Подписаться на газету» в разделе «Газета» — их id сохраняются в Redis; рассылка идёт при вызове `/api/gazette-notify`.

### Автоматическая рассылка после пуша (рекомендуется)

Если репозиторий на GitHub и деплой идёт через Vercel, рассылка может **запускаться сама** после появления новой новости в коде и пуша в `main`:

1. **Deploy-hook** (`/api/deploy-hook`) — загружает задеплоенный сайт, достаёт из него версию газеты (`GAZETTE_VERSION` в `app.js`) и заголовок первой новости из `index.html`, затем вызывает `/api/gazette-notify`. Рассылка по одному и тому же `newsId` (версии) выполняется **один раз**: повторный вызов вернёт `alreadySent: true`.

2. **GitHub Action** (`.github/workflows/notify-gazette-on-deploy.yml`) — при пуше в `main` ждёт 90 секунд (чтобы успел задеплоиться Vercel), затем вызывает deploy-hook.

**Что сделать один раз:**

- В GitHub: **Settings → Secrets and variables → Actions** добавить секрет **CRON_SECRET** (то же значение, что в Vercel для вызова API).
- Опционально: переменную **APP_URL** (например `https://poker-app-ebon.vercel.app`), если деплой на другой домен.

После этого при каждом пуше в `main` с новой новостью (и обновлённым `GAZETTE_VERSION` в `app.js`) подписчики получат пуш, а повторные деплои без смены версии не вызовут повторную рассылку.

**Вызов deploy-hook вручную** (если без GitHub Actions):

```bash
curl -X POST "https://poker-app-ebon.vercel.app/api/deploy-hook?secret=ВАШ_CRON_SECRET"
```

---

### Ручной вызов рассылки (как раньше)

После публикации новой новости можно по-прежнему вызвать вручную (один раз на одну новость):

```bash
curl -X POST "https://poker-app-ebon.vercel.app/api/gazette-notify" \
  -H "Content-Type: application/json" \
  -H "X-Cron-Secret: ВАШ_CRON_SECRET" \
  -d '{"newsId": "2026-02-25_0", "articleIndex": 0, "headline": "КОНЕЦ РОЗЫГРЫША! Клуб в трауре...", "postToChat": true}'
```

- **newsId** — уникальный id этой новости (например `"2026-02-25_0"` или `"5"`). Рассылка по одному и тому же **newsId** выполняется **только один раз**: повторный вызов с тем же id вернёт `alreadySent: true` и никому не отправит сообщения.
- **articleIndex** — номер новости (0, 1, 2…) для ссылки: в сообщение подставится ссылка «Открыть новость: https://t.me/...?startapp=news_0». Без него — ссылка на раздел «Газета» без конкретной статьи.
- **message** — свой текст пуша (если не указан — стандартный текст + ссылка).
- **headline** (или **title**) — заголовок новости; уйдёт в пост в чат.
- **postToChat: true** — дополнительно отправить сообщение со ссылкой в общий чат клуба.

В Vercel добавьте **MINI_APP_URL** (ссылка на Mini App, например `https://t.me/YourBot/app`) — по ней в сообщении будет кликабельная ссылка на новость.
