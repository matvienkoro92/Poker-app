# Poker21 — Telegram Mini App (Welcome Screen)

Простая приветственная страница покерного клуба **Poker21** для запуска внутри Telegram Mini App.

## Стэк

- Чистый HTML / CSS / JavaScript
- Интеграция с `telegram-web-app.js` (инициализация Mini App, отправка события в бота)

## Структура

- `index.html` — основной файл мини-приложения (приветственный экран)
- `styles.css` — оформление и адаптивная верстка
- `app.js` — логика и интеграция с Telegram WebApp
- `package.json` — служебный файл для быстрого локального запуска

## Локальный запуск

```bash
npm install -g serve
serve .
```

После запуска откройте в браузере:

```text
http://localhost:3000
```

## Использование в Telegram

1. Задеплойте содержимое папки на любой статический хостинг (например, на Vercel / Netlify / GitHub Pages / свой сервер).
2. В настройках вашего Telegram-бота укажите URL этого мини-приложения как WebApp.
3. При нажатии на кнопку «Начать игру» Mini App отправит боту JSON:

```json
{ "action": "enter_club" }
```

Далее бот может открыть лобби, список столов и т.п. — в зависимости от вашей логики.

## Счётчик посетителей (уникальные / повторные)

В подвале отображаются «Уникальных» и «Повторных» визитов. Для работы нужен Redis в облаке [Upstash](https://upstash.com) (бесплатный тариф):

1. Зарегистрируйтесь на https://upstash.com и создайте базу Redis.
2. В проекте Vercel: **Settings → Environment Variables** добавьте:
   - `UPSTASH_REDIS_REST_URL` — REST URL вашей базы
   - `UPSTASH_REDIS_REST_TOKEN` — REST Token
3. После деплоя запросы к `/api/visit` будут сохранять визиты и отдавать счётчики.

**Если в подвале везде «—» или 0:** проверьте в Vercel → Settings → Environment Variables, что заданы `UPSTASH_REDIS_REST_URL` и `UPSTASH_REDIS_REST_TOKEN`, затем сделайте повторный деплой. Убедитесь, что в `index.html` у `#app` указан актуальный `data-api-base` (URL вашего приложения на Vercel).

## Авторизация через Telegram

Приложение проверяет, что пользователь открыл Mini App из Telegram: данные `initData` отправляются на сервер и проверяются по токену бота.

1. В Vercel → **Settings → Environment Variables** добавьте переменную **TELEGRAM_BOT_TOKEN** (токен бота от [@BotFather](https://t.me/botfather)).
2. В `index.html` у контейнера `#app` замените атрибут **data-telegram-app-url** на ссылку на вашего бота, например: `https://t.me/ВашБот` или `https://t.me/ВашБот/app`.
3. Если пользователь открывает приложение не из Telegram (например, в браузере), отображается баннер «Откройте приложение в Telegram» и кнопка перехода по этой ссылке. Если открыто из Telegram и проверка прошла успешно, в шапке показывается «Привет, Имя!».
4. **Инициация диалога с ботом:** при первом входе Mini App автоматически откроет `t.me/ВашБот?start=miniapp`, чтобы пользователь инициировал чат с ботом (иначе рассылка напоминаний может не дойти). Пользователь кратко перейдёт в чат бота и может вернуться в приложение через меню бота.

## Чат: общий + личные сообщения

- **Общий чат** — все участники клуба видят сообщения и могут писать.
- **Личные сообщения** — диалоги между пользователями.
- **Админ** (задаётся в `TELEGRAM_ADMIN_ID`): может удалять сообщения в общем и личном чате (кнопка ✕ у каждого сообщения) и писать в личку любому пользователю. Админы: Анна (ID803668), Вика, вы (ID494359). В Vercel задайте **TELEGRAM_ADMIN_ID** — Telegram User ID каждого через запятую (узнать: @userinfobot).

## Сервис напоминаний о турнире дня (пошагово)

Чтобы кнопки «Напомнить за час», «Напомнить за 10 минут» и «Отправить напоминание сейчас» работали, сделайте следующее.

### Шаг 1. Создать базу Redis в Upstash

1. Откройте https://upstash.com и войдите или зарегистрируйтесь.
2. Нажмите **Create Database**.
3. Укажите имя (например, `poker-app`), выберите регион (например, Europe).
4. Нажмите **Create**.
5. Откройте созданную базу и перейдите на вкладку **REST API**.
6. Скопируйте значения:
   - **UPSTASH_REDIS_REST_URL** (длинная ссылка вида `https://....upstash.io`);
   - **UPSTASH_REDIS_REST_TOKEN** (строка токена).

### Шаг 2. Узнать токен Telegram-бота

1. Откройте в Telegram [@BotFather](https://t.me/botfather).
2. Если бота ещё нет: отправьте `/newbot`, придумайте имя и username.
3. Отправьте `/mybots` → выберите бота → **API Token**.
4. Скопируйте токен (вид: `123456789:AAH...`). Это и есть **TELEGRAM_BOT_TOKEN**.

### Шаг 3. Добавить переменные в Vercel

1. Откройте https://vercel.com и выберите проект мини-приложения.
2. Перейдите в **Settings** → **Environment Variables**.
3. Добавьте по одной переменной (для **Production** можно включить галочку; при необходимости — и для Preview):

   | Name | Value |
   |------|--------|
   | `UPSTASH_REDIS_REST_URL` | вставьте URL из шага 1 |
   | `UPSTASH_REDIS_REST_TOKEN` | вставьте токен из шага 1 |
   | `TELEGRAM_BOT_TOKEN` | вставьте токен бота из шага 2 |
4. Нажмите **Save** для каждой.
5. Перейдите в **Deployments**, откройте последний деплой и нажмите **Redeploy**, чтобы применить переменные.
6. **Проверка:** откройте в браузере `https://ВАШ-ДОМЕН.vercel.app/api/reminder-status`. Должно быть `{"redis":"ok"}`. Если `redis: "not_configured"` или `redis: "error"` — в ответе будет подсказка (hint), что исправить.

После этого:
- Подписка на напоминания будет сохраняться в Redis.
- Кнопка **«Напомнить через 10 сек»** — не закрывайте приложение 10 секунд.

### Шаг 4. Напоминания «за час» и «за 10 мин» (по расписанию)

Эти рассылки должны вызываться в заданное время (например, за час и за 10 минут до старта турнира в понедельник в 5:31 по Бали (напоминание только за 10 мин)).

**4.1. Создать секрет для вызова рассылки**

1. Придумайте длинный случайный пароль (например, сгенерируйте на https://randomkeygen.com).
2. В Vercel → **Settings** → **Environment Variables** добавьте:
   - **Name:** `CRON_SECRET`
   - **Value:** этот пароль.
3. Сохраните и снова сделайте **Redeploy**.

**4.2. Настроить вызовы по расписанию**

Турнир в понедельник в 5:31 (Бали) → напоминание «за 10 мин» в 5:21 Бали.

Вариант **А** — бесплатный сервис cron (например, cron-job.org):

1. Зарегистрируйтесь на https://cron-job.org (или аналог).
2. Создайте задачу для «за час»:
   - URL: `https://ВАШ-ДОМЕН.vercel.app/api/freeroll-reminder-send?when=1h&secret=ВАШ_CRON_SECRET`
   - Метод: GET.
   - Расписание: ежедневно в **17:00** (выберите часовой пояс Москва или UTC+3).
3. Создайте вторую задачу для «за 10 мин»:
   - URL: `https://ВАШ-ДОМЕН.vercel.app/api/freeroll-reminder-send?when=10min&secret=ВАШ_CRON_SECRET`
   - Расписание: ежедневно в **17:50**.

Вариант **Б** — Vercel Cron (если используете тариф с cron):

1. В корне проекта создайте файл `vercel.json`:
   ```json
   {
     "crons": [
       { "path": "/api/freeroll-reminder-send", "schedule": "0 14 * * *" },
       { "path": "/api/freeroll-reminder-send", "schedule": "50 14 * * *" }
     ]
   }
   ```
2. В расписании указано UTC (14:00 UTC = 17:00 МСК, 14:50 UTC = 17:50 МСК). Vercel при вызове передаёт заголовок; в коде API проверяется `CRON_SECRET` (заголовок `X-Cron-Secret` или `?secret=...`). Для Vercel Cron при необходимости добавьте в handler поддержку заголовка, который передаёт Vercel (см. документацию Vercel Cron).
3. Задеплойте проект.

**Проверка:** после деплоя нажмите в мини-приложении «Напомнить за час» или «Напомнить за 10 минут» — должно появиться сообщение «Вам придёт сообщение за час до начала» (или за 10 мин) без ошибки. Сообщения в Telegram придут в момент срабатывания крона.

