# Poker21 — Telegram Mini App (Welcome Screen)

Простая приветственная страница покерного клуба **Poker21** для запуска внутри Telegram Mini App.

## Стэк

- Чистый HTML / CSS / JavaScript
- Интеграция с `telegram-web-app.js` (инициализация Mini App, отправка события в бота)

## Структура

- `index.html` — основной файл мини-приложения (приветственный экран)
- `styles.css` — оформление и адаптивная верстка
- `app.js` — логика и интеграция с Telegram WebApp
- `package.json` — служебный файл для быстрого локального запуска

## Локальный запуск

```bash
npm install -g serve
serve .
```

После запуска откройте в браузере:

```text
http://localhost:3000
```

## Использование в Telegram

1. Задеплойте содержимое папки на любой статический хостинг (например, на Vercel / Netlify / GitHub Pages / свой сервер).
2. В настройках вашего Telegram-бота укажите URL этого мини-приложения как WebApp.
3. При нажатии на кнопку «Начать игру» Mini App отправит боту JSON:

```json
{ "action": "enter_club" }
```

Далее бот может открыть лобби, список столов и т.п. — в зависимости от вашей логики.

## Счётчик посетителей (уникальные / повторные)

В подвале отображаются «Уникальных» и «Повторных» визитов. Для работы нужен Redis в облаке [Upstash](https://upstash.com) (бесплатный тариф):

1. Зарегистрируйтесь на https://upstash.com и создайте базу Redis.
2. В проекте Vercel: **Settings** добавьте REST URL и токен вашей базы Redis (из Upstash).
3. После деплоя запросы к `/api/visit` будут сохранять визиты и отдавать счётчики.

**Если в подвале везде «—» или 0:** проверьте в Vercel → Settings, что заданы URL и токен Redis, затем сделайте повторный деплой. Убедитесь, что в `index.html` у `#app` указан актуальный `data-api-base` (URL вашего приложения на Vercel).

## Авторизация через Telegram

Приложение проверяет, что пользователь открыл Mini App из Telegram: данные `initData` отправляются на сервер и проверяются по токену бота.

1. В Vercel → **Settings** добавьте токен бота от [@BotFather](https://t.me/botfather).
2. В `index.html` у контейнера `#app` замените атрибут **data-telegram-app-url** на ссылку на вашего бота, например: `https://t.me/ВашБот` или `https://t.me/ВашБот/app`.
3. Если пользователь открывает приложение не из Telegram (например, в браузере), отображается баннер «Откройте приложение в Telegram» и кнопка перехода по этой ссылке. Если открыто из Telegram и проверка прошла успешно, в шапке показывается «Привет, Имя!».
4. **Инициация диалога с ботом:** при первом входе Mini App автоматически откроет `t.me/ВашБот?start=miniapp`, чтобы пользователь инициировал чат с ботом (иначе рассылка напоминаний может не дойти). Пользователь кратко перейдёт в чат бота и может вернуться в приложение через меню бота.

## Чат: общий + личные сообщения

- **Общий чат** — все участники клуба видят сообщения и могут писать.
- **Личные сообщения** — диалоги между пользователями.
- **Админ** (задаётся в настройках Vercel): может удалять сообщения (✕), банить пользователей, редактировать свои, использовать контекстное меню по long‑press. Под ID админов показывается «(админ)». Дефолтные админы: Анна (2144406710), Роман (5053253480), вы. В Vercel задайте Telegram User ID админов через запятую (узнать в @userinfobot). Без этого метка «(админ)» и кнопки админа не появятся.

## Сервис напоминаний о турнире дня (пошагово)

Чтобы кнопки «Напомнить за час», «Напомнить за 10 минут» и «Отправить напоминание сейчас» работали, сделайте следующее.

### Шаг 1. Создать базу Redis в Upstash

1. Откройте https://upstash.com и войдите или зарегистрируйтесь.
2. Нажмите **Create Database**.
3. Укажите имя (например, `poker-app`), выберите регион (например, Europe).
4. Нажмите **Create**.
5. Откройте созданную базу и перейдите на вкладку **REST API**.
6. Скопируйте REST URL (длинная ссылка вида `https://....upstash.io`) и токен.

### Шаг 2. Узнать токен Telegram-бота

1. Откройте в Telegram [@BotFather](https://t.me/botfather).
2. Если бота ещё нет: отправьте `/newbot`, придумайте имя и username.
3. Отправьте `/mybots` → выберите бота → **API Token**.
4. Скопируйте токен (вид: `123456789:AAH...`).

### Шаг 3. Добавить настройки в Vercel

1. Откройте https://vercel.com и выберите проект мини-приложения.
2. Перейдите в **Settings**.
3. Добавьте (для **Production** можно включить галочку; при необходимости — и для Preview):
   - URL Redis и токен Redis из шага 1;
   - токен бота из шага 2.
4. Нажмите **Save** для каждой записи.
5. Перейдите в **Deployments**, откройте последний деплой и нажмите **Redeploy**, чтобы применить настройки.
6. **Проверка:** откройте в браузере `https://ВАШ-ДОМЕН.vercel.app/api/reminder-status`. Должно быть `{"redis":"ok"}`. Если `redis: "not_configured"` или `redis: "error"` — в ответе будет подсказка (hint), что исправить.

После этого:
- Подписка на напоминания будет сохраняться в Redis.
- Кнопка **«Напомнить через 10 сек»** — не закрывайте приложение 10 секунд.

### Шаг 4. Напоминания «за час» и «за 10 мин» (по расписанию)

Эти рассылки должны вызываться в заданное время (например, за час и за 10 минут до старта турнира в понедельник в 5:31 по Бали (напоминание только за 10 мин)).

**4.1. Создать секрет для вызова рассылки**

1. Придумайте длинный случайный пароль (например, сгенерируйте на https://randomkeygen.com).
2. В Vercel → **Settings** добавьте секретный пароль для вызова рассылки.
3. Сохраните и снова сделайте **Redeploy**.

**4.2. Настроить вызовы по расписанию**

Турнир в понедельник в 5:31 (Бали) → напоминание «за 10 мин» в 5:21 Бали.

Вариант **А** — бесплатный сервис cron (например, cron-job.org):

1. Зарегистрируйтесь на https://cron-job.org (или аналог).
2. Создайте задачу для «за час»:
   - URL: `https://ВАШ-ДОМЕН.vercel.app/api/freeroll-reminder-send?when=1h&secret=ВАШ_СЕКРЕТ`
   - Метод: GET.
   - Расписание: ежедневно в **17:00** (выберите часовой пояс Москва или UTC+3).
3. Создайте вторую задачу для «за 10 мин»:
   - URL: `https://ВАШ-ДОМЕН.vercel.app/api/freeroll-reminder-send?when=10min&secret=ВАШ_СЕКРЕТ`
   - Расписание: ежедневно в **17:50**.

Вариант **Б** — Vercel Cron (если используете тариф с cron):

1. В корне проекта создайте файл `vercel.json`:
   ```json
   {
     "crons": [
       { "path": "/api/freeroll-reminder-send", "schedule": "0 14 * * *" },
       { "path": "/api/freeroll-reminder-send", "schedule": "50 14 * * *" }
     ]
   }
   ```
2. В расписании указано UTC (14:00 UTC = 17:00 МСК, 14:50 UTC = 17:50 МСК). При вызове передаётся секрет (заголовок или `?secret=...`). Для Vercel Cron при необходимости добавьте в handler поддержку заголовка (см. документацию Vercel Cron).
3. Задеплойте проект.

**Проверка:** после деплоя нажмите в мини-приложении «Напомнить за час» или «Напомнить за 10 минут» — должно появиться сообщение «Вам придёт сообщение за час до начала» (или за 10 мин) без ошибки. Сообщения в Telegram придут в момент срабатывания крона.

## «Найди Пиханину» — сброс призов

В игре отображается «Осталось призов: X». Чтобы обнулить счётчик и снова показывать полный остаток (15):

1. Зайди в **Vercel** → проект → **Settings**.
2. Найди секрет для сброса (тот же, что для напоминаний) и скопируй его значение (без пробелов в начале и конце).

**Вариант А — терминал (macOS/Linux):**
  ```bash
  chmod +x scripts/reset-pikhanina.sh
  ./scripts/reset-pikhanina.sh ВСТАВЬ_СЮДА_СЕКРЕТ_ИЗ_VERCEL
  ```
  Если проект на другом домене: `./scripts/reset-pikhanina.sh ВСТАВЬ_СЕКРЕТ https://твой-домен.vercel.app`**Вариант Б — одна команда curl** (подставь свой секрет):
  ```bash
  curl "https://poker-app-ebon.vercel.app/api/pikhanina?reset=1&secret=ВСТАВЬ_СЕКРЕТ"
  ```
  В ответе должно быть `"reset":true`. Тогда обнови мини-приложение.

**Вариант В — браузер:** открой вкладку и вставь в адресную строку (подставь секрет):
  ```text
  https://poker-app-ebon.vercel.app/api/pikhanina?reset=1&secret=ВСТАВЬ_СЕКРЕТ
  ```
  Должен открыться JSON с `"reset": true`. Обнови мини-приложение.

Если в терминале «Permission denied» — выполни один раз: `chmod +x scripts/reset-pikhanina.sh`.  
Если ошибка 401/403 — секрет не совпадает, перепроверь значение в Vercel и что оно сохранено (после смены настроек сделай Redeploy).
